---
layout: post
status: publish
published: true
title: "LinkindleÂ : Affichez votre consommation Ã©lectrique sur une liseuse"
author: outadoc
author_login: outadoc
author_email: outadoc@gmail.com
author_url: https://outadoc.fr
wordpress_id: 1136
wordpress_url: https://outadoc.fr/?p=1136
date: '2016-12-04 21:10:05 +0000'
date_gmt: '2016-12-04 20:10:05 +0000'
categories:
- Tutos
- Technologeek
tags: []
comments:
- id: 675
  author: Papa bless
  author_email: goofster.gafster@protonmail.ch
  author_url: ''
  date: '2017-01-28 20:02:13 +0000'
  date_gmt: '2017-01-28 19:02:13 +0000'
  content: |-
    Super article, il faut absolument que je teste Ã§a.
    Ã‡a fonctionnerait sur une K4Â ?
- id: 676
  author: outadoc
  author_email: outadoc@gmail.com
  author_url: https://outadoc.fr
  date: '2017-01-29 19:11:15 +0000'
  date_gmt: '2017-01-29 18:11:15 +0000'
  content: |-
    En principe Ã§a fonctionnera sans souci sur n'importe quel Kindle, du moment qu'on peut le jailbreaker.<br />
    Il faudra juste ajuster les constantes GRAPH_WIDTH_IN, GRAPH_HEIGHT_IN, et GRAPH_DPI dans <code>linky_plot.py</code> si la rÃ©solution est diffÃ©rente.
- id: 677
  author: Papa bless
  author_email: goofster.gafster@protonmail.ch
  author_url: ''
  date: '2017-01-30 01:37:14 +0000'
  date_gmt: '2017-01-30 00:37:14 +0000'
  content: J'ai mÃªme pas eu besoin les changer, Ã§a marche nickel.
- id: 678
  author: outadoc
  author_email: outadoc@gmail.com
  author_url: https://outadoc.fr
  date: '2017-01-30 15:30:01 +0000'
  date_gmt: '2017-01-30 14:30:01 +0000'
  content: GÃ©nialÂ !Â ?
- id: 679
  author: steph
  author_email: steph.marie@gmail.com
  author_url: ''
  date: '2017-04-10 13:27:16 +0100'
  date_gmt: '2017-04-10 11:27:16 +0100'
  content: |-
    Bonjour,
    La requÃªte post de la fonction _get_data de linky.py me retourne un 301 Moved Permanently, pourtant le token rÃ©cupÃ©rÃ© dans la fonction login est bien valide.
    J'ai vÃ©rifiÃ© sur le site enedis, les paramÃ¨tres/payload/cookie n'ont pas changÃ©, la seul diffÃ©rence c'est qu'ils utilisent une url en *.enedis.fr/* au lieu de *.erdf.fr/* mais Ã§a change rien.
    Une idÃ©e d'oÃ¹ peut venir le problÃ¨me?
    Merci.
- id: 680
  author: outadoc
  author_email: outadoc@gmail.com
  author_url: ''
  date: '2017-04-13 23:35:54 +0100'
  date_gmt: '2017-04-13 21:35:54 +0100'
  content: |-
    Hello,
    J'ai en effet remarquÃ© le problÃ¨me il y a environ un mois, mais je n'ai pas trouvÃ© de solution sur le coup et je n'ai pas vraiment eu le temps d'approfondir depuis.
    Je rÃ©essayerai Ã  l'occasion â€” Ã  mon avis le problÃ¨me ne doit pas Ãªtre trÃ¨s structurant, mais il risque tout de mÃªme d'Ãªtre embÃªtant Ã  trouverÂ :/
- id: 681
  author: RÃ©cupÃ©rer les infos de votre compteur Linky â€“ Cipher
    Bliss
  author_email: ''
  author_url: http://www.cipherbliss.com/recuperer-les-infos-de-votre-compteur-linky/
  date: '2018-01-26 11:48:20 +0000'
  date_gmt: '2018-01-26 10:48:20 +0000'
  content: "[â€¦] source: {{ site.baseurl }}/2016/12/linkindle-courbe-conso-electrique-sur-liseuse/
    [â€¦]"
---
Lorsque le compteur connectÃ© Linky a Ã©tÃ© annoncÃ©, ERDF (maintenant Enedis) s'est trouvÃ©e au coeur d'une controverse sur la vie privÃ©e et la collecte des donnÃ©es de la consommation Ã©lectrique des franÃ§ais. Je ne chercherai pas ici Ã  justifier ou condamner ses pratiques, mais je vais au moins vous montrer comment vous pouvez en profiter pour votre usage personnel.&nbsp;ğŸ˜‰

Voulant garder un oeil sur ma consommation Ã©lectrique durant l'hiver tout en profitant des donnÃ©es maintenant fournies directement par Enedis, j'ai crÃ©Ã© le projet Linkindle.

[![linkindle]({{ site.baseurl }}/assets/IMG_20161204_190043-768x576.jpg "Linkindle, fini et accrochÃ© au mur")][1]

L'afficheur est accrochÃ© au mur de mon appartement et allumÃ© en permanence. GrÃ¢ce Ã  l'Ã©cran e-ink de la Kindle, la batterie devrait tenir des semaines sans nÃ©cessiter de recharge. L'histogramme est mis Ã  jour une fois par jour.

D'un point de vue technique, les graphiques sont **gÃ©nÃ©rÃ©s une fois par jour** *via* un **script `cron`** qui tourne sur un **serveur dÃ©diÃ©** (un simple Raspberry Pi fait l'affaire). Ils sont crÃ©Ã©s par un script Python et la bibliothÃ¨que matplotlib qui rÃ©cupÃ¨re traite les donnÃ©es d'Enedis, avant d'Ãªtre mis Ã  disposition sur un serveur web sur le rÃ©seau local.

La **Kindle** (une simple Kindle Basic suffit) a Ã©tÃ© **jailbreakÃ©e** et fait Ã©galement tourner un script `cron` une fois par jour. Ce dernier **rÃ©cupÃ¨re le graphique** sur le serveur web et l'affiche.

Allez, on rentre dans les dÃ©tailsÂ ! Tout est open-source, donc avec un peu d'huile de coude et de matÃ©riel vous pouvez avoir **la mÃªme chez vous**. ğŸ‘Œ

## Comment faireÂ ?

### PrÃ©requis

Pour commencer, et c'est important Ã  prÃ©ciser, il va vous falloir un compteur Linky activÃ©. L'installation est une premiÃ¨re Ã©tape, mais vous devrez attendre jusqu'Ã  plusieurs mois avant de recevoir un courrier de la part d'Enedis vous confirmant l'activation du compteur.

Vous devrez ensuite demander sur leur site web la crÃ©ation d'un compte personnel liÃ© au compteur, une opÃ©ration qui peut encore prendre plusieurs jours. AprÃ¨s Ã§a, vous Ãªtes prÃªtsÂ ! VÃ©rifiez que vous avez bien accÃ¨s aux donnÃ©es sur votre espace personnel.

En ce qui concerne le Kindle, n'importe lequel devrait faire l'affaireÂ ; vÃ©rifiez simplement qu'il peut Ãªtre jailbreakÃ© avant de dÃ©penser des dizaines d'euros dans une brique. Et notez que vous ne pouvez pas Ã©conomiser 10â‚¬ en achetant la version avec les offres spÃ©cialesÂ : j'ai testÃ©, et Ã§a ne fonctionne pas. ğŸ˜’ Si toutefois vous avez fait cette erreur, vous pouvez dÃ©sactiver ces derniÃ¨res depuis [le site d'Amazon][2].

### CÃ´tÃ© serveur

Le cÃ´tÃ© serveur sera le plus simple Ã  configurer. Vous pouvez commencer par rÃ©cupÃ©rer le projet [sur Github][3]. Installez les dÃ©pendances. Sur une DebianÂ :

```bash
$ apt-get install python3 pip3 python3-numpy python3-matplotlib python3-requests python3-dateutil python3-tk texlive texlive-latex-extra texlive-fonts-recommended dvipng imagemagick
```

Mettez ensuite en place un serveur web quelconque. Apache fait trÃ¨s bien l'affaire.

Dans le rÃ©pertoire du projet, Ã©ditez le fichier `gen_graphs.sh` et ajoutez votre identifiant et mot de passe Enedis dans les variables respectives. Remplacez la valeur de `OUT_DIR` par un dossier accessible depuis votre serveur web. Attention aux permissionsÂ !

Vous pouvez tester l'exÃ©cution du script avec cette simple commandeÂ :

```bash
$ ./gen_graphs.sh
```

Enfin, on pourra mettre en place une tÃ¢che `cron` pour rÃ©cupÃ©rer les donnÃ©es quotidiennement.

```bash
$ crontab -e

# m h  dom mon dow   command
0 5 * * * /home/iot/linkindle/gen_graphs.sh
```

Remplacez bien sÃ»r `/home/iot/linkindle/` par le rÃ©pertoire du projet. Le script sera ainsi appelÃ© tous les jours Ã  5h du matin.

### CÃ´tÃ© Kindle

Cette partie Ã©tant un peu plus dÃ©licate (il est assez rare d'Ãªtre "expert(e) en jailbreak de Kindle" ğŸ˜¶) et moins bien documentÃ©e, je vais essayez de la dÃ©couper en plusieurs parties.

Gardez en tÃªte que ce tutoriel a Ã©tÃ© Ã©crit en 2016. La mÃ©thode de jailbreak peut avoir changÃ© si vous lisez Ã§a dans le futur. Faites attention Ã  ce que vous faites, je ne suis pas responsable de ce que *vous* faites avec *votre* matÃ©rielÂ ! Si vous avez des problÃ¨mes, n'hÃ©sitez pas Ã  laisser un commentaire.

#### Jailbreak

Commencez par identifier le modÃ¨le de votre Kindle [grÃ¢ce Ã  cette page][4].

La faille utilisÃ©e pour le jailbreak des Kindle les plus rÃ©centes n'est plus prÃ©sente dans les derniÃ¨res versions de leur firmware. Vous allez donc devoir downgrader votre appareil dans une version supportÃ©e en suivant Ã  la lettre les instructions de [ce thread][5].

Les outils que j'ai utilisÃ© proviennent du forum et wiki MobileRead. AprÃ¨s avoir cherchÃ© pendant *longtemps* la source de certaines erreurs, j'ai dÃ©couvert qu'il existe [**une** page depuis laquelle tout tÃ©lÃ©charger][6]. C'est la seule Ã  avoir les versions les plus rÃ©centes de tous les outils. ConsidÃ©rez-la comme votre Bible Ã  partir de maintenant.

#### KUAL (Kindle Universal Application Launcher)

TÃ©lÃ©chargez KUAL depuis la page des snapshots, puis glissez le fichier `.azw2` adaptÃ© dans le dossier `documents` Ã  la racine de votre Kindle. VÃ©rifiez que vous avez une nouvelle entrÃ©e dans la liste des livres sur la Kindle. Ce hack est une interface qui vous permettra de lancer simplement un tas d'extensions, dont celles qui nous intÃ©ressent.

[Thread principal][7]

#### MobileRead Package Installer

Pour pouvoir installer des packages sur les versions rÃ©centes du firmware des Kindle, vous aurez besoin de MobileRead Package Installer (ou mrpi). Installez simplement le rÃ©pertoire tÃ©lÃ©chargÃ© dans le dossier `extensions` Ã  la racine du Kindle.

[Thread principal][8]

#### Screensaver hack

Le screensaver hack (ou linkss) permet de remplacer les fonds d'Ã©cran par dÃ©faut de la Kindle par n'importe quelle image au bon format. On va s'en servir pour afficher les images de nos histogrammesÂ !

Pour l'installer, glissez les fichiers `*.bin` nÃ©cessaires dans le dossier racine de votre Kindle (y compris Python 2.7, qui est Ã©galement fourni, et qui est une dÃ©pendance). Ensuite, ouvrez KUAL, puis sÃ©lectionnez MR Package Installer et lancez l'installation.

[![python sur kindle]({{ site.baseurl }}/assets/IMG_20161125_183232-768x576.jpg "Installons Python tranquillement")][9]

[Thread principal][10]

#### Online Screensaver

Dernier morceau de magie pour donner vie Ã  notre bidouilleÂ : l'extension Online Screensaver, qui va se charger de rÃ©cupÃ©rer notre image, depuis notre serveur web, Ã  intervalles dÃ©finies prÃ©alablement. Sans cette extension, les scripts `cron` ne fonctionnent pas correctement, et le mode veille de la Kindle interfÃ¨re avec le rÃ©seau.

TÃ©lÃ©chargez l'extension [depuis cette page][11] et placez-la dans le dossier `extensions` Ã  la racine de votre Kindle. Il vous faudra ensuite la configurer en modifiant le fichier `onlinescreensaver/bin/config.sh` pour y insÃ©rer l'URL du graphe que vous voulez afficher et la frÃ©quence de rafraÃ®chissement.

#### TestonsÂ !

Et voilÃ , tout devrait Ãªtre configurÃ© correctement. Faites un test en lanÃ§ant une mise Ã  jour du screensaver depuis KUAL > Online Screensaver. Essayez de redÃ©marrer la Kindle, et boum, Ã§a devrait Ãªtre bonÂ ! ğŸ˜€

[![kindle au mur]({{ site.baseurl }}/assets/IMG_20161204_205043-768x576.jpg "o/")][12]

## Comment Ã§a marcheÂ ?

### CÃ´tÃ© serveur

Pour rÃ©cupÃ©rer les donnÃ©es de consommation Ã©lectriques, j'ai du faire un reverse-engineering lÃ©ger du site d'Enedis. Il se trouve qu'ils fournissent aux utilisateurs connectÃ©s un fichier JSON assez complet et simple Ã  utiliser, paramÃ©trable par date de dÃ©but et de fin. L'authentification se fait classiquement par un appel Ã  une page de login et la conservation d'un cookie de session.

Vous pouvez retrouver la partie de rÃ©cupÃ©ration des donnÃ©es brutes (et la rÃ©utiliser dans un autre projet si tel est votre dÃ©sirÂ !) dans le module Python `linky.py`.

La gÃ©nÃ©ration des histogrammes est rÃ©alisÃ©e par `linky_plot.py`. J'utilise `matplotlib` et le module LaTeX pour rÃ©aliser de beaux graphiques. Ce script appelle directement le module dÃ©crit prÃ©cÃ©demment.

Enfin, le point d'entrÃ©e "normale" est le fichier `gen_graphs.sh`, dans lequel est appelÃ© le script Python 3, mais Ã©galement l'outil `imagemagick`, qui est **hyper important** pour la gÃ©nÃ©ration d'images adaptÃ©es Ã  l'Ã©cran de la Kindle. Un paramÃ¨tre incorrect, et les rÃ©sultats seront inutilisables.

[1]: {{ site.baseurl }}/assets/IMG_20161204_190043.jpg
[2]: https://www.amazon.fr/mycd
[3]: https://github.com/outadoc/linkindle/
[4]: http://wiki.mobileread.com/wiki/Kindle_Serial_Numbers
[5]: http://www.mobileread.com/forums/showthread.php?t=275877
[6]: http://www.mobileread.com/forums/showthread.php?t=225030
[7]: http://www.mobileread.com/forums/showthread.php?t=203326
[8]: http://www.mobileread.com/forums/showthread.php?t=251143
[9]: {{ site.baseurl }}/assets/IMG_20161125_183232.jpg
[10]: http://www.mobileread.com/forums/showthread.php?t=195474
[11]: http://www.mobileread.com/forums/showthread.php?t=236104
[12]: {{ site.baseurl }}/assets/IMG_20161204_205043.jpg
